

### 操作手指南

注：所有模式都可以重新设计，想实现任何功能都可以和电控组交流。

操作手**若熟悉电控代码设计思路和具体实现，就容易在赛场上处理应急情况**。当然，任何同学只要**训练得足够多**，**和电控队员交流得多**，都可以非常熟悉机器人的控制性能。

机器人在场上完成任务。半自动机器人靠操作手控制移动，可以靠计算机自动瞄准。操作手的界面与第一人称射击游戏相同。机器人搭载的图传模块将视频信号发送给操作手的电脑。而操作手在键盘、鼠标上的操作会通过遥控器发送到机器人上的遥控器接收机。接收机接收的是遥控器摇杆、拨杆、键盘按键是否按下（Q,W,E,R,A,S,D,F,G,SHIFT,Z,X,C,V,B,CTRL），鼠标移动速度。电控程序包含机器人如何根据这些指令移动的信息。

##### 安全说明

当遥控器离线时，机器人进入无力模式，各个机构发送零电流。这也可以用于在赛场上不用关闭总电源的前提下让机器人底盘无力，方便推动。遥控器重新上线时，机器人会根据遥控器右上方拨杆的位置确定模式。上——普通车；中——小陀螺；下——卡yaw车。注意这可能导致遥控器上线时机器人就开始小陀螺旋转，需注意安全。

##### 模式设计说明

除了离线的无力模式外，机器人有三个工作模式。各个模式有不同特点，在键鼠操作和遥控器操作上相互补充。遥控器总体的思想是：左边摇杆等价于键盘，右边摇杆等价于鼠标。

###### 模式切换方法

三个模式都可以通过按键或者遥控器右拨杆的移动切换。键盘和拨杆冲突时，以**最新变化**的控制器（键盘或者遥控器拨杆）的命令为准。

键盘CVB分别顺序对应三个模式，遥控器右上拨杆上中下也分别顺序对应三个模式。

###### 普通车模式（Common car)：完整运动（C 上）

机器人底盘可以直接实现复杂的运动，包括任意方向平移和附加旋转。机器人的移动复杂度其实受限于操作手的指令的简单性和遥控器通道的不足。普通车模式是为了完整实现机器人的所有行为。设计的键盘按键有前后左右平移和顺逆旋转，为底盘坐标系控制，亦即，以机器人的底盘而非操作手的视角为前后左右的参照。鼠标控制云台的单独的旋转。

按C键进入，取common car的首字母，方便记忆。或者将右拨杆移到上方。

左边摇杆只能控制前后平移和旋转，不能控制左右平移。右边摇杆控制云台绝对角度变化。

键盘ed：前后平移；键盘sf：逆时针和顺时针旋转；键盘ag：左右平移；

Auto时，NUC控制云台独立旋转。

###### 小陀螺模式：避弹（V 中）

小陀螺模式。为了给对方自瞄程序带来干扰，底盘持续自动转动，而云台发射机构一直面对对方机器人。底盘根据机械结构宏定义文件自动确定是小陀螺还是准小陀螺。无电滑环的准小陀螺模式下，机器人底盘在旋转一定圈数后会反向转动一定圈数，从而避免线被绕断。

右拨杆在中时进入，或者键盘按V时进入。原因是V长得像一个陀螺。遥控器左摇杆控制在云台坐标系下的前后左右平移，右摇杆控制云台旋转。 Auto时， NUC控制云台独立方向。



###### 坏yaw（卡yaw）模式：应急 （B 下）

坏yaw 车模式，考虑比赛中yaw轴可能卡住的意外情况。卡住时，操作手可以手动进入此模式时，程序会尝试回正云台，一定时间内回正不了就自动放弃并在此模式中向yaw轴电机发送0电流。wsad控制前后左右平移，鼠标pitch上下和整体旋转。此时，遥控器左边摇杆控制机器人在云台坐标系中前后左右平移。

拨杆在下时进入，以及键盘按B时进入。原因是取Bad yaw 的首字母B。

为了继续保证机器人的云台转向和自瞄功能，Auto模式NUC控制云台pitch和机器人整体转向。实现的原理是角度PID控制输出的角速度乘以系数后交给底盘控制任务，底盘执行此旋转指令。



键盘和鼠标控制

| 模式     | 底盘控制视角 | 键盘                                      | 鼠标                             |
| -------- | ------------ | ----------------------------------------- | -------------------------------- |
| C普通车  | 底盘本身     | ED前后平移，SF底盘左右旋转,AG底盘左右平移 | 云台上下左右旋转                 |
| V小陀螺  | 云台视角     | WS前后平移，AD底盘左右平移                | 云台上下左右旋转                 |
| B坏yaw车 | 云台视角     | WS前后平移，AD底盘左右平移                | 云台上下旋转、机器人整体左右旋转 |

只有遥控器的情况下的控制

| 模式     | 底盘控制视角 | 遥控器左摇杆           | 遥控器右摇杆                     |
| -------- | ------------ | ---------------------- | -------------------------------- |
| C普通车  | 底盘本身     | 前后平移，底盘左右旋转 | 云台上下左右旋转                 |
| V小陀螺  | 云台视角     | 前后平移，底盘左右平移 | 云台上下左右旋转                 |
| B坏yaw车 | 云台视角     | 前后平移，底盘左右平移 | 云台上下旋转、机器人整体左右旋转 |



###### 射击说明

射击的设计代码说明中，有相关操作设计和原因的说明

> 发射涉及两种电机。一个拨弹轮在弹舱内，起到输送荧光弹的作用；两个摩擦轮（摩擦力很大）的驱动电机在炮口位置。荧光弹的大小略小于弹性摩擦轮之间的间隙。为了发射子弹，需要首先开启摩擦轮，待摩擦轮速度增加到很高时，让拨弹轮转动，将子弹推到摩擦轮前，发射出去。如果摩擦轮未转动，而拨弹轮却将子弹推到了摩擦轮前，就会导致卡弹。

> 遥控器离线时关闭发射机构所有相关电机，Shift键开启摩擦轮。遥控器左上拨杆上拨后移到中间，可以开启或关闭摩擦轮。当遥控器左拨杆移到中间时，允许鼠标控制发射。鼠标左键按下后立刻抬起，发射一颗子弹；左键按住不放，连发。鼠标右键按下不放：允许NUC控制发射单发或者连发。当然，遥控器左上拨杆也可控制发射。在摩擦轮开启的前提下，置于下端，而后立刻置于中间，发射一颗子弹；置于下端不停，连发。键盘开启键设计原因如下：虽然在比赛过程中，不需要关闭摩擦轮，键盘开启和关闭按钮似乎多余，但是实际比赛过程中，操作手距离机器人很远，看不到摩擦轮是否开启。为了能够确保摩擦轮开启，设计一个shift键，只能发送开启摩擦轮的命令。而不在键盘上留关闭摩擦轮的按键，目的是防止操作手误触导致摩擦轮关闭卡弹。

> 这里，长按是通过时间判断的。宏定义中有对长时间的定义，可以根据操作手的习惯修改时间。
>
> ```c
> #define PRESS_LONG_TIME     700    //长时间按住的定义为700ms，700个时钟周期
> ```

> 射频也可以在宏定义中修改。
>
> ```c
> //**************射击电机控制常量
> #define SHOOT_MULTI_FREQUENCY   6       //射击频率：个/s
> #define SHOOT_MULTI_TIME_GAP    (1000/SHOOT_MULTI_FREQUENCY)    //连发射击时间间隔
> #define SHOOT_SPEED_LIMIT 0.3f          //摩擦轮速度。未来可以测试摩擦轮速度和射速的关系
> #define SHOOT_TRIGGER_SPEED_LIMIT 0.25f   //拨弹轮开启时速度
> 
> ```

###### 射速调整方法

新增了按键射速调整，按下R键和Q键可以选择不同的射速。R（弱 ruo）是低射速。Q（强 qiang）是高射速。在击打大风车时，可以选择高射速，让弹道更直。电控代码实现如下。

```c
static void setFinalSpeedByKey(void)
{
    if(rc_p->key.v & KEY_PRESSED_OFFSET_R)
        wantFinalSpeed=SHOOT_SPEED_LIMIT_R;
    if(rc_p->key.v & KEY_PRESSED_OFFSET_Q)
        wantFinalSpeed=SHOOT_SPEED_LIMIT_Q;
}
```

###### 自瞄说明

在键盘上按Z键开启自瞄（取“自”的拼音首字母Z），按X键关闭自瞄进入手动模式并且清除自瞄修正偏移量。鼠标右键按住不放，允许NUC控制发射。

开启自瞄后，机器人云台会根据NUC反馈的角度旋转，直到让待击打位置到达摄像机画面中心。因为自瞄可能有误差，允许操作手手动设计偏移量。在按下Z键后，操作手对于鼠标的操控将转化为偏移量：对于自瞄角度的偏移。例如，当操作手上移鼠标一段距离后不动，那么机器人将会自动瞄准到新的位置，这个位置是相对于原来的自瞄结果上方一段距离的位置。这是操作手和NUC合作瞄准。这个偏移量会一直生效。

当操作手希望清除这个偏移量时，可以按下X键，像一个叉叉取消掉自瞄，机器人进入手动模式，清除刚才的偏移量（亦即上文的“修正偏移量”）。重新按Z键，可以恢复自瞄，以零偏移开始。

当NUC掉线时，机器人会立刻进入手动模式。掉线是根据NUC发送的数据帧的时间判断的。

当开启自瞄模式、但NUC未找到装甲板时，机器人切换到手动模式，但是修正偏移量会保存下来，不被清空。当下一次遇到装甲板时，机器人会立刻进入自瞄模式，并在2s之后允许操作手增加新的偏移量（这是为了避免在发现装甲板的一瞬间操作手的鼠标运动会破坏刚刚修正好的偏移量）。

